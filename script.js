const log=(c,m,...a)=>console.log(`[${c}]`,m,...a);const db={n:'forthDB',v:2,s:{d:'dictionary',s:'stacks',o:'output'},db:null,async init(){log('DB','Initializing IndexedDB');return new Promise((resolve,reject)=>{const req=indexedDB.open(this.n,this.v);req.onerror=()=>{log('DB','Error initializing DB');reject(req.error);};req.onsuccess=()=>{this.db=req.result;log('DB','Connected to DB');Promise.all([this.load('d'),this.load('s'),this.load('o')]).then(resolve);};req.onupgradeneeded=e=>{log('DB','Creating/upgrading database');const db=e.target.result;if(!db.objectStoreNames.contains(this.s.d)){db.createObjectStore(this.s.d,{keyPath:'n'});}if(!db.objectStoreNames.contains(this.s.s)){db.createObjectStore(this.s.s,{keyPath:'id'});}if(!db.objectStoreNames.contains(this.s.o)){db.createObjectStore(this.s.o,{keyPath:'t',autoIncrement:true});}};});},async load(t){if(!this.db)throw new Error('DB not initialized');const store=this.s[t];const tx=this.db.transaction([store],'readonly');const st=tx.objectStore(store);return new Promise((resolve,reject)=>{const req=t==='s'?st.get('current'):st.getAll();req.onsuccess=()=>{if(t==='d'){req.result.forEach(w=>{cw.d.set(w.n,{d:w.d,des:w.des});});cw.upd();cw.updDel();}else if(t==='s'){const s=req.result;if(s){f.ds=s.ds||[];f.rs=s.rs||[];upd();}}else if(t==='o'){req.result.sort((a,b)=>b.t-a.t).forEach(o=>out(o.txt,false));}resolve();};req.onerror=()=>reject(req.error);});},async save(t,data){if(!this.db)throw new Error('DB not initialized');const store=this.s[t];const tx=this.db.transaction([store],'readwrite');const st=tx.objectStore(store);return new Promise((resolve,reject)=>{const req=t==='o'?st.add(data):st.put(data);req.onsuccess=resolve;req.onerror=()=>reject(req.error);});},async del(n){if(!this.db)throw new Error('DB not initialized');const tx=this.db.transaction([this.s.d],'readwrite');const st=tx.objectStore(this.s.d);return new Promise((resolve,reject)=>{const req=st.delete(n);req.onsuccess=resolve;req.onerror=()=>reject(req.error);});}};const nrm=w=>typeof w==='string'?w.toUpperCase():w;const f={ds:[],rs:[],dic:new Map(),cs:[],li:null};const cw={d:new Map(),has:n=>cw.d.has(nrm(n)),cnt:()=>cw.d.size,async add(n,d,des){try{const nn=nrm(n);const nd=d.split(/\s+/).map(t=>nrm(t)).join(' ');await db.save('d',{n:nn,d:nd,des});this.d.set(nn,{d:nd,des});this.upd();this.updDel();log('CW',`Added: ${nn}`);}catch(e){throw new Error(`Save failed: ${e.message}`);}},async del(n){const nn=nrm(n);if(!this.has(nn))throw new Error("Not found");try{await db.del(nn);this.d.delete(nn);this.upd();this.updDel();log('CW',`Deleted: ${nn}`);}catch(e){throw new Error(`Delete failed: ${e.message}`);}},upd(){const c=document.getElementById('cwc');c.className='wc';c.innerHTML='';this.d.forEach((data,n)=>{const b=document.createElement('button');Object.assign(b,{className:'wb',textContent:n,title:data.des,onclick:()=>push(n)});const g=document.createElement('div');g.className='bg';g.appendChild(b);c.appendChild(g);});},updDel(){document.querySelector('.f2').classList.toggle('nw',this.cnt()===0);}};const upd=()=>{const c=document.getElementById('dsc');c.innerHTML='';f.ds.forEach((v,i)=>{const b=document.createElement('button');b.className='wb'+(i===f.ds.length-1?' top':'');b.textContent=v;b.title=`Type: ${typeof v}`;c.appendChild(b);});log('Stack',{data:f.ds,ret:f.rs,ctrl:f.cs});};const push=v=>{if(!isNaN(v)&&typeof v!=='boolean'){f.ds.push(Number(v));}else if(f.dic.has(nrm(v))||cw.has(nrm(v))){f.ds.push(nrm(v));}else{f.ds.push(v);}upd();db.save('s',{id:'current',ds:f.ds,rs:f.rs,t:Date.now()});log('Stack','Current:',f.ds);};const out=(txt,save=true)=>{const o=document.getElementById('outc');const l=document.createElement('div');l.textContent=txt;o.insertBefore(l,o.firstChild);if(save)db.save('o',{txt,t:Date.now()});};const ex=w=>{const n=nrm(w);log('Execute',`Word: ${n}`);if(n==='IF'){if(f.ds.length<1)throw new Error("unf");const cond=f.ds.pop();f.cs.push({t:'IF',e:cond!==0,h:false});return null;}if(n==='ELSE'){if(!f.cs.length||f.cs[f.cs.length-1].t!=='IF')throw new Error("ELSE wo IF");const ci=f.cs[f.cs.length-1];if(ci.h)throw new Error("Multi ELSE");ci.e=!ci.e;ci.h=true;return null;}if(n==='THEN'){if(!f.cs.length||f.cs[f.cs.length-1].t!=='IF')throw new Error("THEN wo IF");f.cs.pop();return null;}if(f.cs.length>0&&f.cs[f.cs.length-1].t==='IF'&&!f.cs[f.cs.length-1].e)return null;if(!isNaN(w)&&typeof w!=='boolean'){const num=Number(w);f.ds.push(num);log('Stack','Pushed number:',num);upd();return null;}if(f.dic.has(n)){switch(n){case'DUP':{if(f.ds.length<1)throw new Error("unf");const v=f.ds[f.ds.length-1];f.ds.push(v);upd();return`DUP: ${v}`;}case'DROP':{if(f.ds.length<1)throw new Error("unf");const v=f.ds.pop();upd();return`DROP: ${v}`;}case'SWAP':{if(f.ds.length<2)throw new Error("unf");const[b1,a1]=[f.ds.pop(),f.ds.pop()];f.ds.push(b1,a1);upd();return`SWAP: ${a1} ${b1}`;}case'DO':{if(f.ds.length<2)throw new Error("unf");const[lim,ini]=[f.ds.pop(),f.ds.pop()];if(typeof lim!=='number'||typeof ini!=='number')throw new Error("num req");f.cs.push({t:'DO',i:ini,l:lim,skip:false});upd();return null;}case'I':{if(!f.cs.length||f.cs[f.cs.length-1].t!=='DO')throw new Error("I out DO");const cl=f.cs[f.cs.length-1];f.ds.push(cl.i);upd();return`I: ${cl.i}`;}case'LOOP':{if(!f.cs.length||f.cs[f.cs.length-1].t!=='DO')throw new Error("LOOP wo DO");const l=f.cs[f.cs.length-1];l.i++;if(l.i<l.l){l.skip=true;return'continue';}f.cs.pop();upd();return null;}}}const cop={'=':(a,b)=>a===b?-1:0,'<>':(a,b)=>a!==b?-1:0,'<':(a,b)=>a<b?-1:0,'>':(a,b)=>a>b?-1:0,'<=':(a,b)=>a<=b?-1:0,'>=':(a,b)=>a>=b?-1:0};if(cop[n]){if(f.ds.length<2)throw new Error("unf");const[b,a]=[f.ds.pop(),f.ds.pop()];if(typeof a!=='number'||typeof b!=='number')throw new Error("num req");const result=cop[n](a,b);f.ds.push(result);upd();return`${a} ${n} ${b} = ${result}`;}const mop={'+':((a,b)=>a+b),'-':((a,b)=>a-b),'*':((a,b)=>a*b),'/':(a,b)=>{if(b===0)throw new Error("div 0");return Math.floor(a/b);}};if(mop[n]){if(f.ds.length<2)throw new Error("unf");const[b,a]=[f.ds.pop(),f.ds.pop()];if(typeof a!=='number'||typeof b!=='number')throw new Error("num req");const result=mop[n](a,b);f.ds.push(result);upd();return`${a} ${n} ${b} = ${result}`;}if(cw.has(nrm(n))){const{d}=cw.d.get(nrm(n));let out=[];const ws=d.split(/\s+/);for(let i=0;i<ws.length;i++){const o=ex(ws[i]);if(o==='continue'){i=-1;}else if(o){out.push(o);}}return out.length?`${n}: ${out.join(', ')}`:null;}f.ds.push(w);log('Stack','Pushed literal:',w);upd();return null;};const hinp=e=>{if(e.key==='Enter'&&e.target.value.trim()){const v=e.target.value.trim();const n=Number(v);push(!isNaN(n)&&typeof n!=='boolean'?n:v);e.target.value='';e.preventDefault();}};const hdef=(e,cur)=>{if(e.key==='Enter'){e.preventDefault();const fs=['wn','wd','wdes'];const ci=fs.indexOf(cur);if(ci===fs.length-1){def();document.getElementById('wn').focus();}else{document.getElementById(fs[ci+1]).focus();}}};const def=async()=>{const[n,d,des]=['wn','wd','wdes'].map(id=>document.getElementById(id).value.trim());try{if(!n||!d)throw new Error("name & def req");if(f.dic.has(nrm(n)))throw new Error("cant redef builtin");await cw.add(n,d,des);['wn','wd','wdes'].forEach(id=>document.getElementById(id).value='');out(`Defined: ${nrm(n)}`);}catch(e){out(`Error: ${e.message}`);}};const hdel=async e=>{if(e.key==='Enter'){const n=e.target.value.trim();try{if(f.dic.has(nrm(n)))throw new Error("cant del builtin");await cw.del(n);e.target.value='';out(`Deleted: ${nrm(n)}`);}catch(e){out(`Error: ${e.message}`);}};};const ddel=e=>{e.preventDefault();document.getElementById('del').value=e.dataTransfer.getData('text');};const adrp=e=>{e.preventDefault();};const drps=(e,t)=>{e.preventDefault();const d=e.dataTransfer.getData('text');if(t==='dsi'){document.getElementById('dsi').value=d;}else if(t==='ds'){push(isNaN(d)?d:Number(d));}};const run=()=>{try{const ts=[...f.ds];f.ds=[];f.cs=[];ts.forEach((w,i)=>{const o=ex(w);if(o)out(o);upd();});db.save('s',{id:'current',ds:f.ds,rs:f.rs,t:Date.now()});}catch(e){out(`Error: ${e.message}`);f.ds=[];f.cs=[];upd();db.save('s',{id:'current',ds:f.ds,rs:f.rs,t:Date.now()});}};const init=async()=>{try{await db.init();['+','-','*','/','DUP','DROP','SWAP','OVER','ROT','>R','R>','@','!','IF','ELSE','THEN','DO','LOOP','I','VARIABLE','CONSTANT','=','<>','<','>','<=','>='].forEach(w=>f.dic.set(nrm(w),w));document.getElementById('dsi').addEventListener('keypress',hinp);cw.updDel();log('Init','App initialized with IndexedDB');}catch(e){log('Error',`DB init failed: ${e.message}`);out(`Error: Failed to initialize database`);}};document.addEventListener('DOMContentLoaded',init);